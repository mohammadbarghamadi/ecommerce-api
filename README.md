# Ecommerce API
برای راه اندازی یک فروشگاه آنلاین با Nodejs میتوانید از اسکریپت Ecommerce API استفاده کنید. اسکریپت Ecommerce API با زبان Typescript نوشته شده است و در آن از زبانها و ابزارهای Node.js – Mongodb – Mongoose – Express.js و … استفاده شده است.

## ویژگی‌های Ecommerce API
اسکریپت Ecommerce API دارای اکثر ویژگی‌های یک سایت فروشگاهی کامل می‌باشد که در ادمه به شرح برخی از این ویژگی‌ها می پردازم:

### سیستم احراز هویت
در سیستم احراز هویت ایکامرس ای پی آی، از ابزار JsonWebToken برای ایجاد توکن تایید هویت استفاده شده است. این سیستم به صورت Role Based تنظیم شده و دارای چهار سطح دسترسی میباشد:
1. **ریشه: (Root)** این سطح دسترسی مدیر اصلی برنامه است و کلیه تنظیمات و قابلیت های سایت را میتواند مدیریت کند.
2. **مدیر: (Admin)** این سطح دسترسی مدیران سایت است که توسط مدیر اصلی (Root) سایت ایجاد شده است و توانایی ایجاد تنظیمات سطح پایین سایت مثل ایجاد حساب کاربری فروشنده (Seller) و … دارا است.
3. **فروشنده: (Seller)** این سطح دسترسی فروشنده سایت است که توانایی بررسی و مدیریت فروشگاه سایت را دارا است. ایجاد و حذف و ویرایش محصول و بارگذاری فایل و … از جمله توانایی سطح دسترسی فروشنده است.
4. **مشتری: (Customer)** این سطح دسترسی مشتریان سایت است که میتوانند در سایت ثبت نام کرده و به محصولات سایت را خریداری کنند و یا اطلاعات حساب کاربری خود را بررسی کرده و به سفارشات خود دسترسی داشته باشند. (به صورت پیشفرض کاربرانی که در سایت ثبت نام میکنند در این سطح دسترسی قرار میگیرند)

ویژگی های سیستم احراز هویت ایکامرس ای پی آی:

### ورود و ثبت نام
- ثبت نام با ایمیل و شماره موبایل (بدون ارسال کد)
- ورود با ایمیل و شماره موبایل
- خروج از حساب کاربری
- خروج از همه دستگاه ها
- نمایش پروفایل کاربری
- بروز رسانی حساب کاربری
- فراموشی رمز عبور (ارسال ایمیل)
- بازیابی رمز عبور
- حذف حساب کاربری

### بخش مدیریت کاربران
- نقش بندی کاربران (ریشه،مدیر،فروشنده،مشتری)
- نمایش فهرست کاربران
- جستجو در کاربران
- ایجاد حساب کاربری
- ویرایش حساب های کاربری
- حذف حساب های کاربری

### مدیریت محصولات
مدیران و فروشندگان سایت میتوانند محصول ایجاد کرده و یا محصولات سایت را ویرایش و حذف کنند. همچنین میتوانند فهرست خرید های آنجام شده در سایت را بررسی کرده و آنها را تایید و رد کنند.
- ایجاد یا افزودن محصول
- بروز رسانی محصولات
- فهرست گرفتن از محصولات
- نمایش جزئیات محصول
- جستجو در محصولات
- حذف محصولات

### مدیریت سبد خرید
مشتریان میتوانند محصولات مورد نظر خود را به سبد خرید اضافه کنند و یا سبد خرید خود را ویرایش و حذف کنند.
- افزودن به سبد خرید
- اهده سبد خرید
- وز رسانی سبد خرید
- حذف سبد خرید

### پرداخت آنلاین
پس از افزودن محصول به سبد خرید توانایی پرداخت آنلاین فعال شده و با پرداخت و تایید تراکنش، خرید انجام شده و سبد خرید کاربر به فهرست سفارشات کاربر منتقل میشود.
- پرداخت با درگاه پرداخت آنلاین
- بررسی پرداخت انجام شده

### مدیریت سفارش‌ها
مشتریان میتوانند فهرست سفارشات خود را دریافت کرده و جزئیات هر سفارش را بررسی کنند. همچنین این فهرست توسط فروشندگان نیز قابل مشاهده است.
- فهرست گرفتن از سفارشات
- نمایش جزئیات سفارش

### دسته بندی محصولات
مدیران سایت میتوانند برای محصولات دسته ایجاد کرده و این دسته ها را ویرایش و حذف کنند. همچنین قابلیت نمایش محصولات بر اساس دسته ها وجود دارد.
- افزودن دسته و زیر دسته
- ویرایش دسته
- فهرست گیری دسته ها
- نمایش محصولات دسته
- حذف دسته ها

### مدیریت برچسب ها
مدیران سایت میتوانند برای محصولات برچسب ایجاد کرده و این برچسب ها را ویرایش و حذف کنند. همچنین قابلیت نمایش محصولات بر اساس برچسب ها وجود دارد.
- فهرست گیری از برچسب ها
- ویرایش برچسب ها
- افزودن برچسب ها
- نمایش محصولات هر برچسب
- حذف برچسب ها

### مدیریت دیدگاه ها و نظرات
کاربران ثبت نام شده و غیر ثبت نام شده میتوانند برای هر محصول دیدگاه ثبت کنند و به محصولات امتیاز دهند. همچنین کاربران ثبت نام شده میتوانند دیدگاه های خود را ویرایش کنند. کلیه دیدگاه ها توسط مدیران سایت باید تایید و یا رد شود.
- ثبت دیدگاه یا نظر روی محصول
- فهرست گیری از نظرات
- نمایش نظرات هر محصول
- ویرایش نظرات
- حذف نظرات

### سیستم مدیریت فایل
فروشندگان و مدیران سایت میتوانند فایلهای خود را آپلود کنند. فایلهای آپلود شده فروشندگان فقط توسط خود آنها قابل ویرایش و حذف شدن است و مدیران سایت میتوانند کلیه فایلها را مدیریت کنند.
- فهرست گیری از فایل‌ها
- مشاهده جزئیات هر فایل
- آپلود کردن فایل (پسوند های مشخص)
- ویرایش فایل‌ها
- حذف فایل های آپلود شده

### علاقه مندی ها
مشتریان سایت میتوانند محصولات مورد علاقه خود را به فهرست علاقه مندی های اضافه کرده و یا آنرا از فهرست خود حذف کنند.
- افزودن به علاقه مندی ها
- حذف از علاقه مندی ها
- نمایش فهرست علاقه مندی ها

### مدیریت مکان ها
مدیران سایت میتوانند در سایت کشور و استان/ایالت و شهر ایجاد کرده و مشخص کنند استان ها و یا شهر ها متعلق به کدام کشور یا استان/ایالت است.
- ایجاد یا افزودن مکان (کشور – استان/ایالت – شهر)
- فهرست گرفتن از مکان ها
- نمایش مکان (مثلا استان و شهر های زیرمجموع)
- ویرایش و بروز رسانی مکان
- حذف مکان ها

### مدیریت آدرس‌ها
مشتریان میتوانند آدرس خود را در پروفایل کاربری خود ثبت و اضافه کنند تا محصول به آدرس مشخص شده در پروفایل کاربر، ارسال شود.
- افزودن یا ایجاد آدرس
- نمایش آدرس
- ویرایش آدرس
- حذف آدرس

## مستندات برنامه

برای اجرا و استفاده از Ecommerce API مستندات مذکور در این بخش را به صورت کامل مطالعه کرده و طبق دستورالعمل پیش روید.

### اجرای برنامه در سیستم شخصی
برای اجرای برنامه در سیستم شخصی باید نرم افزار ها و ماژول های زیر را در سیستم خود نصب داشته باشید و یا آنها را نصب کنید:
```
Node.js ==> https://nodejs.org/en
TypeScript ==> https://www.typescriptlang.org/download
Mongodb ==> https://www.mongodb.com
NPM ==> https://www.npmjs.com/
```
```
bcrypt: 5.1.0
cookie-parser: 1.4.6
cors: 2.8.5
express: 4.18.2
express-fileupload: 1.4.0
jsonwebtoken: 8.5.1
mongoose: .8.0
nodemailer: 6.8.0
dotenv: 16.0.3
```
در صورتیکه برنامه Nodejs را در سیستم خود نصب داشته باشید با اجرای دستور زیر در پوشه پروژه کلیه ماژولهای مورد نیاز به صورت خودکار نصب خواهند شد:
```
npm install
```
برای نصب TypeScript میتوانید از دستور زیر استفاده کنید:
```
npm install typescript
```
### تنظیم متغیر های محیطی

بعد از نصب برنامه ها و ماژول های مورد نیاز یک فایل با نام .env در پوشه اصلی پروژه ایجاد کنید و متغیر های زیر را در آن ایجاد کنید:
```
PORT=8000
# پورت دسترسی به برنامه
DB_URI=mongodb://127.0.0.1:27017/
# آدرس دسترسی به سرور Mongodb میتواند Mongodb Atlas یا Local Database باشد
DB_NAM=ecommerce
# نام پایگاه داده
JWT_SECRET_KEY=7b51677da05da7ebcd4be6499ea87cfe31f5a7af9552ad234e2b52dd934ec
# یک مقدار تصادفی 30 بایتی برای متد ساین JWT

EMAIL_USER=email@example.com
EMAIL_PASS=password
EMAIL_SERV=mail.example.com
# آدرس ایمیل و رمز عبور و میل سرور خود را در این سه فیلد به ترتیب وارد کنید.

ZARIN_PAY_MERCHANT=merchantId
ZARIN_PAY_ADDRESS=https://api.zarinpal.com/pg/v4/payment/request.json
ZARIN_PAY_PGSTART=https://www.zarinpal.com/pg/StartPay/
PAYMENT_CALLBACK_URL=http://localhost:3000/checkout
# در این بخش اطلاعات درگاه پرداخت را باید پر کنید که در حال حاضر فقط درگاه پرداخت زرین پال قابل استفاده است.
```
### اجرای بک اند

بعد از نصب برنامه ها و ماژول های مورد نیاز و تنظیم متغیر های محیطی در فایل .env نوبت به اجرای ایکامرس ای پی آی میرسد. برای این منظور کافیست از دستورات زیر استفاده کنید:

```
tsc -w
npm run dev
```
دستور tsc فایلهای تایپ اسکریپت را به JavaScript تبدیل میکند و آنها را در پوشه dist ذخیره میکند. سپس دستور npm run dev برنامه را در حالت توسعه اجرا میکند.

نکته: برای اجرای برنامه به صورت عادی میتوانید از npm start استفاده کنید.

## نحوه ارسال ریکوست
برای ارسال ریکوست به بک اند به فرمت JSON باید طبق دستورالعمل های زیر اقدام کنید، توجه کنید بجای مقدار {{URL}} باید از آدرس سرور مورد نظر خود استفاده کنید.

### ثبت نام در برنامه

برای ثبت نام در برنامه به آدرس زیر با متد Post ریکوست ارسال کنید:

POST: {{URL}}/api/user/signup


| فیلد | نوع | توضیحات |
| :---:  | :---:  |  ---: |
| name* | string | نام و نام خانوادگی کاربر |
| email* | string | آدرس ایمیل کاربر |
| phone | string | شماره موبایل کاربر |
| password* | string | رمز عبور کاربر |
| role | number | غیر قابل انتخاب (پیشفرض مشتری) |

نمونه ریکوست:
```
{
    "name": "Mohammad Barghamadi",
    "email": "mohammadbarghamadi@gmail.com",
    "phone": "9304551004",
    "password": "83d43c6e56bb7af02962ce0f"
}
```
مقدار بازگشتی:

اگر فرایند ثبت نام به صورت صحیح و درست انجام شود خروجی مقدار بازگشتی به صورت زیر میباشد:
```
{
    "status": 200,
    "data": {
        "name": "Mohammad Barghamadi",
        "email": "mohammadbarghamadi@gmail.com",
        "phone": "9304551004",
        "role": 2000,
        "_id": "63bfba9f3c79dfd0eb8d0dae",
        "createdAt": "2023-01-12T07:45:35.044Z",
        "updatedAt": "2023-01-12T07:45:35.044Z",
        "__v": 0
    },
    "message": "New user created!"
}
```

### ورود به برنامه

برای ورود به برنامه به آدرس زیر با متد Post ریکوست ارسال کنید:

POST: {{URL}}/api/user/signin


| فیلد | نوع | توضیحات |
| :---:  | :---:  |  ---: |
| username | string | آدرس ایمیل یا شماره موبایل کاربر ثبت نام شده |
| password | string | رمز عبور حساب کاربر |


نمونه ریکوست:

``` json
{
    "phone": "9304551004",
    "password": "83d43c6e56bb7af02962ce0f"
}
```

مقدار بازگشتی:

در صورتیکه فرایند ورود به برنامه موفقیت آمیز باشد همراه با پاسخ یک توکن در هدر به سمت کاربر ارسال میشود که نام آن authToken است و برای ارسال ریکویست های بعدی (احراز هویت شده) میتوانید از این توکن استفاده کنید.
``` json
{
    "status": 200,
    "data": {
        "_id": "63bfba9f3c79dfd0eb8d0dae",
        "name": "Mohammad Barghamadi",
        "email": "mohammadbarghamadi@gmail.com",
        "phone": "9304551004",
        "role": 2000,
        "createdAt": "2023-01-12T07:45:35.044Z",
        "updatedAt": "2023-01-12T08:15:44.581Z",
        "__v": 1
    },
    "message": "User signed in."
}
```
در صورت اشتباه بودن نام کاربری یا رمز عبور مقدار بازگشتی به صورت زیر میشود:
``` json
{
    "success": false,
    "error": "Invalid Credentials!"
}
```

### خروج از برنامه

برای خروج از برنامه با متد Post به آدرس زیر ریکوست ارسال کنید، به طور پیشفرض توکن احراز هویت که به صورت HttpOnly در Cookie ذخیره شده به برنامه ارسال می‌شود.

Post: {{URL}}/api/user/signout

نکته: با ارسال این ریکوست توکن از حساب کاربری در پایگاه داده حذف شده و فاقد اعتبار میشود.

مقدار بازگشتی:
``` json
{
    "status": 200,
    "message": "signout with success!"
}
```

### خروج از همه دستگاه ها

برای خروج از همه دستگاه ها بجز دستگاه فعلی که با آن به برنامه وارد شده اید میبایست به آدرس زیر با متد Post ریکوست ارسال کنید:

Post: {{URL}}/api/user/signoutall

مقدار بازگشتی:
``` json
{
    "status": 200,
    "message": "Signed out from all devices!"
}
```
### دریافت پروفایل

برای دریافت پروفایل کاربر به آدرس زیر با متد Get ریکوست ارسال کنید.

Get: {{URL}}/api/user/profile

مقدار بازگشتی:
``` json
{
    "status": 200,
    "data": {
        "_id": "63bfba9f3c79dfd0eb8d0dae",
        "name": "Mohammad Barghamadi",
        "email": "mohammadbarghamadi@gmail.com",
        "phone": "9304551004",
        "role": 2000,
        "createdAt": "2023-01-12T07:45:35.044Z",
        "updatedAt": "2023-01-13T04:51:49.026Z",
        "__v": 3
    },
    "message": "User profile"
}
```
### بروز رسانی پروفایل

بای بروز رسانی پروفایل کاربر به آدرس زیر با متد Patch ریکوست ارسال کنید:

Patch: {{URL}}/api/user/update

| فیلد | نوع | توضیحات |
| :---:  | :---:  |  ---: |
| name | string | نام و نام خانوادگی کاربر |
| email | string | آدرس ایمیل کاربر |
| phone | string | شماره موبایل کاربر |
| password | string | رمز عبور کاربر |
| role | number | غیر قابل تغییر (فقط مدیر میتواند تغییر دهد) |

نمونه ریکوست:
```
{
    "password": "mynewpassword"
}
```

مقدار بازگشتی:
``` json
{
    "status": 200,
    "data": {
        "_id": "63bfba9f3c79dfd0eb8d0dae",
        "name": "Mohammad Barghamadi",
        "email": "mohammadbarghamadi@gmail.com",
        "phone": "9304551004",
        "role": 2000,
        "createdAt": "2023-01-12T07:45:35.044Z",
        "updatedAt": "2023-01-13T05:24:22.869Z",
        "__v": 3
    },
    "message": "User updated!"
}
```
خطای بازگشتی در صورت ارسال فیلد نامرتبط:
``` json
{
    "success": false,
    "error": "Invalid fields!"
}
```
### فراموشی رمز عبور

در صورت فراموشی رمز عبور به آدرس زیر با متد Post ریکوست ارسال کنید:

Post: {{URL}}/api/user/forgot

| فیلد | نوع | توضیحات |
| :---:  | :---:  |  ---: |
| email | string | آدرس ایمیل کاربر |

نمونه ریکوست:
``` json
{
    "email": "mohammadbarghamadi@gmail.com"
}
```
در صورت موفقیت آمیز بودن فرایند یک ایمیل به کاربر ارسال میشود که حاوی لینک بازیابی رمز عبور است. نمونه لینک:

{{URL}}/reset/4447f4ea8917250b4bdf3f3d1946f42f977

با کلیک بر روی لینک بالا کاربر به صفحه ریست پسور در فرانت منتقل میشود و از آن قسمت میبایست مقدار پارامتری که در جلوی reset وجود دارد به همراه رمز عبور تازه به بکاند یا همان برنامه ما ارسال شود.

### بازیابی رمز عبور

برای بازیابی رمز عبور ریکوست خود را به آدرس زیر با متد Post ارسال کنید.

Post: {{URL}}/api/user/reset/4447f4ea8917250b4bdf3f3d1946f42f977

| فیلد | نوع | توضیحات |
| :---:  | :---:  |  ---: |
| password | string | رمز عبور جدید کاربر را وارد کنید |

نمونه ریکوست:
``` json
{
    "password": "mynewpass"
}
```

نکته: برای منقضی نشدن توکن حداکثر 10 دقیقه زمان برای کلیک بر روی لینک بازیابی رمز عبور و ارسال رمز عبور دارید.

مقدار بازگشتی:
``` json
{
    "status": 200,
    "message": "Your password changed!"
}
```
مقدار بازگشتی در صورت بروز خطا:
``` json
{
    "success": false,
    "error": "Invalid request!"
}
```

### حذف حساب کاربری

برای حذف حساب کاربری با متد Delete یک ریکوست به آدرس زیر بفرستید:

Delete: {{URL}}/user/delete

مقدار بازگشتی:
``` json
{
    "status": 200,
    "message": "Your account removed!"
}
```